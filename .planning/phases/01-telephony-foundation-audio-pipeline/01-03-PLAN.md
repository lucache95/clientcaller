---
phase: 01-telephony-foundation-audio-pipeline
plan: 03
type: execute
wave: 3
depends_on:
  - 01-02
files_modified:
  - README.md
  - tests/test_e2e_call.md
autonomous: false
requirements:
  - TEL-01
  - TEL-02
  - TEL-04

must_haves:
  truths:
    - "User can call Twilio number and system answers"
    - "User can speak and system receives audio (verified via logs)"
    - "System can play audio back to caller (test with echo)"
    - "System maintains stable connection for 2+ minute call"
  artifacts:
    - path: "README.md"
      provides: "Setup and testing instructions"
      min_lines: 80
    - path: "tests/test_e2e_call.md"
      provides: "End-to-end testing checklist"
      min_lines: 30
  key_links:
    - from: "ngrok"
      to: "localhost:8000"
      via: "Public HTTPS tunnel"
      pattern: "ngrok.*8000"
    - from: "Twilio phone number"
      to: "ngrok URL /twiml"
      via: "Voice webhook configuration"
      pattern: "Voice.*URL.*twiml"
---

<objective>
Establish end-to-end testing infrastructure using ngrok for local development and validate complete telephony pipeline with real phone calls.

Purpose: Verify the entire system works with actual Twilio connections before moving to speech processing phases.
Output: Documented testing procedures and verified working telephony foundation.
</objective>

<execution_context>
@/Users/lucassenechal/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lucassenechal/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-telephony-foundation-audio-pipeline/01-RESEARCH.md
@.planning/research/STACK.md
@.planning/phases/01-telephony-foundation-audio-pipeline/01-01-SUMMARY.md
@.planning/phases/01-telephony-foundation-audio-pipeline/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive setup and testing documentation</name>
  <files>
    README.md
    tests/test_e2e_call.md
    .env.example
  </files>
  <action>
Create README.md with complete setup and testing instructions:

```markdown
# Client Caller - Real-Time AI Phone Calling System

A real-time AI phone calling system powered by Twilio, featuring natural conversation with sub-500ms latency.

## Current Status

**Phase 1: Telephony Foundation & Audio Pipeline** ✅ (In Testing)

- [x] FastAPI WebSocket server for Twilio Media Streams
- [x] Audio format conversion (mu-law ↔ PCM, 8kHz ↔ 16kHz)
- [x] Bidirectional streaming with backpressure handling
- [x] Call state management and lifecycle tracking
- [x] Outbound call initiation via Twilio SDK
- [ ] End-to-end testing with real calls

## Prerequisites

### System Requirements

- Python 3.10+ (3.12 recommended)
- FFmpeg (for audio processing)
- Twilio account with phone number
- ngrok account (for local development)

### Install System Dependencies

**macOS:**
```bash
brew install ffmpeg
brew install ngrok
```

**Linux (Ubuntu/Debian):**
```bash
sudo apt-get update
sudo apt-get install -y ffmpeg
# Install ngrok: https://ngrok.com/download
```

## Installation

### 1. Clone and Setup Python Environment

```bash
# Create virtual environment
python3 -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install dependencies
pip install --upgrade pip
pip install -r requirements.txt
```

### 2. Configure Environment Variables

Copy `.env.example` to `.env`:
```bash
cp .env.example .env
```

Edit `.env` with your Twilio credentials:
```env
TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_AUTH_TOKEN=your_auth_token_here
TWILIO_PHONE_NUMBER=+1234567890
SERVER_HOST=0.0.0.0
SERVER_PORT=8000
```

Get your Twilio credentials from: https://console.twilio.com/

### 3. Start ngrok Tunnel

In a separate terminal:
```bash
ngrok http 8000
```

Copy the `Forwarding` URL (looks like `https://abc123.ngrok.io`)

## Running the Server

### Development Mode

```bash
# Activate virtual environment if not already active
source venv/bin/activate

# Run server
python -m src.main
```

Server will start on http://localhost:8000

**Endpoints:**
- `/health` - Health check
- `/ws` - WebSocket endpoint for Twilio Media Streams
- `/twiml` - TwiML configuration endpoint
- `/call/outbound` - API to initiate outbound calls

### Configure Twilio Phone Number

1. Go to https://console.twilio.com/us1/develop/phone-numbers/manage/active
2. Click on your phone number
3. Under "Voice Configuration":
   - **A CALL COMES IN**: Webhook
   - **URL**: `https://YOUR-NGROK-URL/twiml` (e.g., https://abc123.ngrok.io/twiml)
   - **HTTP**: POST
4. Click "Save"

## Testing

### Quick Test: Health Check

```bash
curl http://localhost:8000/health
```

Expected output:
```json
{"status": "healthy", "active_connections": 0}
```

### End-to-End Call Test

See [tests/test_e2e_call.md](tests/test_e2e_call.md) for detailed testing checklist.

**Quick test:**
1. Start server: `python -m src.main`
2. Start ngrok: `ngrok http 8000`
3. Configure Twilio number with ngrok URL
4. Call your Twilio number from your phone
5. Speak into the phone - you should hear your voice echoed back

**Expected behavior:**
- Call connects within 2-3 seconds
- Audio is echoed back (you hear yourself with slight delay)
- Connection remains stable for duration of call
- Logs show message types: connected → start → media → stop

### Unit Tests

```bash
pytest tests/ -v
```

### Outbound Call Test

```bash
curl -X POST "http://localhost:8000/call/outbound?to_number=+15551234567&websocket_url=wss://YOUR-NGROK-URL/ws"
```

Replace `+15551234567` with a phone number you have access to.

## Architecture

```
┌─────────────┐
│   Twilio    │◄──────────────┐
│   (PSTN)    │               │
└──────┬──────┘               │
       │ WebSocket            │
       │ (mulaw/8kHz)         │
┌──────▼──────────────────────┴───┐
│  FastAPI Server (localhost:8000)│
│  - WebSocket handler (/ws)      │
│  - TwiML endpoint (/twiml)      │
│  - Audio conversion pipeline    │
│  - State management             │
└─────────────────────────────────┘
```

## Project Structure

```
src/
├── main.py                 # FastAPI application
├── config.py              # Configuration management
├── twilio/
│   ├── models.py          # Pydantic models for messages
│   ├── handlers.py        # WebSocket message handlers
│   └── client.py          # Twilio API client
├── audio/
│   ├── conversion.py      # Mu-law ↔ PCM conversion
│   ├── resampling.py      # 8kHz ↔ 16kHz resampling
│   └── buffers.py         # Bidirectional streaming
└── state/
    └── manager.py         # Call state machine

tests/
├── test_audio_conversion.py   # Audio pipeline tests
└── test_e2e_call.md           # E2E testing checklist
```

## Troubleshooting

### Server won't start

**Error:** `ModuleNotFoundError`
- Solution: Activate virtual environment: `source venv/bin/activate`

**Error:** `pydub.exceptions.CouldntDecodeError`
- Solution: Install FFmpeg (see Prerequisites)

### No audio in call

**Check:**
1. Logs show "media" events being received
2. ngrok tunnel is running and URL matches Twilio config
3. Audio conversion tests pass: `pytest tests/test_audio_conversion.py -v`

### Call doesn't connect

**Check:**
1. Twilio phone number Voice URL configured correctly
2. ngrok URL is HTTPS (not HTTP)
3. Server is running and health endpoint responds
4. Twilio account has sufficient balance

### WebSocket disconnects

**Check logs for:**
- "WebSocket disconnected" message with call_sid
- Any error messages before disconnect
- Audio queue depth warnings (should not exceed 50)

## Next Steps

Phase 1 focuses on telephony foundation. Next phases will add:

- **Phase 2:** Speech-to-Text with streaming (Whisper)
- **Phase 3:** Language Model with streaming (Gemma 3 27B)
- **Phase 4:** Text-to-Speech with streaming (CSM)
- **Phase 5:** Interruption handling & polish
- **Phase 6:** Cloud GPU deployment

## License

[Your License]

## Support

For issues or questions, see project documentation.
```

Create end-to-end testing checklist in tests/test_e2e_call.md:

```markdown
# End-to-End Call Testing Checklist

## Prerequisites

- [ ] Server running: `python -m src.main`
- [ ] ngrok tunnel active: `ngrok http 8000`
- [ ] Twilio phone number configured with ngrok URL
- [ ] Valid Twilio credentials in `.env`

## Test 1: Inbound Call - Basic Connection

**Objective:** Verify system accepts inbound calls and maintains connection.

**Steps:**
1. Call your Twilio number from your phone
2. Wait for call to connect (2-3 seconds)
3. Listen for any audio/tone
4. Stay on call for 30 seconds
5. Hang up

**Expected Results:**
- [ ] Call connects successfully
- [ ] Server logs show: `connected` → `start` → `media` events
- [ ] Call remains stable for full 30 seconds
- [ ] Logs show `stop` event on hangup
- [ ] No error messages in server logs
- [ ] Health endpoint shows `active_connections: 0` after hangup

**Server Logs to Verify:**
```
INFO - WebSocket connected to Twilio
INFO - Stream started: MZ..., Call: CA...
INFO - Connection accepted for call: CA...
DEBUG - Received audio chunk: 160 bytes
...
INFO - Stream stopped: CA...
INFO - Call cleanup: CA..., Duration: 30.2s
```

## Test 2: Inbound Call - Audio Echo

**Objective:** Verify bidirectional audio streaming works.

**Steps:**
1. Call your Twilio number
2. Wait for connection
3. Say "Hello, testing one two three"
4. Listen for echo response
5. Speak several more sentences
6. Stay on call for 1 minute
7. Hang up

**Expected Results:**
- [ ] You hear your own voice echoed back
- [ ] Echo has slight delay (expected network latency)
- [ ] Audio quality is clear (not garbled or distorted)
- [ ] Echo works consistently for entire call
- [ ] Logs show `audio_received_count` and `audio_sent_count` increasing
- [ ] No queue overflow warnings

**Audio Quality Checks:**
- [ ] Voice is recognizable
- [ ] No crackling or distortion
- [ ] No robotic artifacts (would indicate mu-law conversion issues)
- [ ] Volume is appropriate (not too quiet/loud)

## Test 3: Inbound Call - Connection Stability

**Objective:** Verify system handles longer calls without issues.

**Steps:**
1. Call your Twilio number
2. Stay on call for 2-3 minutes
3. Speak intermittently (every 15-20 seconds)
4. Monitor server logs during call
5. Hang up

**Expected Results:**
- [ ] Call remains connected for full duration
- [ ] No WebSocket disconnects
- [ ] Audio continues working throughout
- [ ] Memory usage stable (no leaks)
- [ ] Queue depth remains bounded (< 50)
- [ ] Cleanup happens correctly on hangup

**Monitor Logs For:**
- No "WebSocket disconnected" before intentional hangup
- No "Audio queue full" warnings
- No "Error handling message" logs
- Steady stream of "Received audio chunk" logs

## Test 4: Outbound Call

**Objective:** Verify system can initiate outbound calls.

**Prerequisites:**
- [ ] Have a phone number you can call (your personal phone)

**Steps:**
1. Ensure server and ngrok running
2. Make outbound call API request:
   ```bash
   curl -X POST "http://localhost:8000/call/outbound?to_number=+1YOUR_PHONE&websocket_url=wss://YOUR_NGROK_URL/ws"
   ```
3. Answer the incoming call on your phone
4. Speak and listen for echo
5. Stay on call for 30 seconds
6. Hang up

**Expected Results:**
- [ ] API returns call_sid and status
- [ ] Your phone rings within 3-5 seconds
- [ ] Call connects when answered
- [ ] Audio echo works (same as inbound test)
- [ ] Call remains stable
- [ ] Logs show same message flow as inbound

**API Response to Verify:**
```json
{
  "call_sid": "CA...",
  "status": "queued",
  "to": "+1...",
  "from": "+1...",
  "direction": "outbound-api"
}
```

## Test 5: Multiple Concurrent Calls (Optional)

**Objective:** Verify system can handle multiple simultaneous calls.

**Steps:**
1. Call Twilio number from Phone 1
2. While connected, call from Phone 2 (or use outbound API)
3. Both calls should echo audio
4. Hang up Phone 1, verify Phone 2 still works
5. Hang up Phone 2

**Expected Results:**
- [ ] Both calls connect successfully
- [ ] Each call has independent audio echo
- [ ] Logs show two separate call_sids
- [ ] Health endpoint shows `active_connections: 2`
- [ ] Hanging up one call doesn't affect the other
- [ ] State manager tracks both calls correctly

## Test 6: Error Handling

**Objective:** Verify graceful handling of abnormal conditions.

**Test 6a: Server Restart During Call**
1. Establish call
2. Kill server (Ctrl+C)
3. Verify call disconnects gracefully

Expected:
- [ ] Call drops (expected behavior)
- [ ] No errors in terminal
- [ ] Can restart server without issues

**Test 6b: ngrok Tunnel Expires**
1. Establish call
2. Stop ngrok (Ctrl+C in ngrok terminal)
3. Observe behavior

Expected:
- [ ] Call may disconnect or freeze
- [ ] Server logs show WebSocket disconnect
- [ ] Server continues running (doesn't crash)

**Test 6c: Invalid Twilio Credentials**
1. Put invalid credentials in `.env`
2. Try to start server or make outbound call

Expected:
- [ ] Outbound call fails with authentication error
- [ ] Error message is clear and logged
- [ ] Server doesn't crash

## Common Issues and Solutions

### Issue: No echo heard

**Check:**
- Logs show "Received audio chunk" messages?
- Logs show "Queued audio chunk" messages?
- AudioStreamer started successfully?

**Solution:**
- Verify audio conversion tests pass
- Check queue depth isn't maxed out (50)
- Restart server and try again

### Issue: Garbled audio

**Possible causes:**
- Mu-law conversion error
- Sample rate mismatch
- Buffer overflow

**Solution:**
- Run audio conversion tests
- Check for queue warnings in logs
- Verify FFmpeg is installed correctly

### Issue: Call connects but no media events

**Check:**
- Twilio Voice URL configured with correct ngrok URL?
- ngrok URL is HTTPS (wss:// for WebSocket)?
- /twiml endpoint returns valid XML?

**Solution:**
```bash
# Test TwiML endpoint
curl http://localhost:8000/twiml

# Should return XML with <Stream> tag
```

## Success Criteria

Phase 1 is complete when:

- [x] All Test 1-4 pass consistently
- [x] Audio echo works clearly
- [x] Calls remain stable for 2+ minutes
- [x] Both inbound and outbound calls work
- [x] State management tracks calls correctly
- [x] No memory leaks or resource issues
- [x] Documentation is complete and accurate

## Next Phase Preview

Phase 2 will replace the echo with speech-to-text:
- User speaks → Whisper transcribes → logs show transcript
- No echo anymore, just transcription
- Prepares for LLM integration in Phase 3
```

Update .env.example with testing notes:
```env
# Twilio Configuration
# Get these from: https://console.twilio.com/
TWILIO_ACCOUNT_SID=ACxxxxxxxxxxxxxxxxxxxxxxxxxx
TWILIO_AUTH_TOKEN=your_auth_token_here
TWILIO_PHONE_NUMBER=+1234567890

# Server Configuration
SERVER_HOST=0.0.0.0
SERVER_PORT=8000

# For Testing:
# 1. Start ngrok: ngrok http 8000
# 2. Copy ngrok URL (e.g., https://abc123.ngrok.io)
# 3. Configure Twilio phone number Voice URL: https://abc123.ngrok.io/twiml
# 4. Test inbound: Call your Twilio number
# 5. Test outbound: POST to /call/outbound with your phone number
```

Follow research Pattern 6 for ngrok setup, provide clear testing procedures, document expected behavior vs actual, include troubleshooting for common issues.
  </action>
  <verify>
Check README.md exists and has >80 lines.
Check tests/test_e2e_call.md exists with testing checklist.
Verify .env.example has testing notes.
Run `python -m src.main` and follow README quick test to verify accuracy.
  </verify>
  <done>
README.md exists with installation, setup, and testing instructions.
End-to-end testing checklist exists with clear pass/fail criteria.
Documentation covers common issues and troubleshooting.
.env.example includes testing guidance.
Instructions are accurate and match current implementation.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify end-to-end telephony pipeline</name>
  <action>
This is a checkpoint task requiring human verification. Follow the steps in <how-to-verify> to test the complete telephony pipeline, including setup of ngrok tunnel, Twilio configuration, and end-to-end call testing with audio echo.
  </action>
  <verify>
Human verification required - user will test the system and confirm all pass criteria are met as documented in <how-to-verify>.
  </verify>
  <done>
User has successfully completed end-to-end testing and confirmed that inbound calls work, audio echo is clear, connections are stable for 2+ minutes, and all requirements (TEL-01, TEL-02, TEL-04) are satisfied.
  </done>
  <what-built>
Complete telephony foundation with FastAPI WebSocket server, audio conversion pipeline, bidirectional streaming, call state management, and outbound call capability. Audio echo functionality implemented for testing.
  </what-built>
  <how-to-verify>
**Setup Steps:**
1. Install dependencies: `pip install -r requirements.txt`
2. Install ngrok: `brew install ngrok` (macOS) or from https://ngrok.com/download
3. Create `.env` file from `.env.example` with your Twilio credentials
4. Start server: `python -m src.main`
5. In new terminal, start ngrok: `ngrok http 8000`
6. Copy ngrok HTTPS URL (e.g., `https://abc123.ngrok.io`)
7. Configure Twilio phone number:
   - Go to https://console.twilio.com/us1/develop/phone-numbers/manage/active
   - Click your number
   - Voice Configuration → "A CALL COMES IN" → Webhook
   - URL: `https://YOUR-NGROK-URL/twiml`
   - Save

**Test 1: Health Check**
- Open http://localhost:8000/health
- Expected: `{"status": "healthy", "active_connections": 0}`

**Test 2: TwiML Endpoint**
- Open http://localhost:8000/twiml
- Expected: XML with `<Stream>` tag visible

**Test 3: Inbound Call with Audio Echo**
- Call your Twilio number from your phone
- Wait for connection (2-3 seconds)
- Say "Hello, testing one two three"
- **Expected:** You should hear your own voice echoed back with slight delay
- Speak several more sentences
- Stay on call for at least 1 minute
- Verify audio continues working throughout
- Hang up

**Test 4: Server Logs Verification**
While on call, check server logs show:
- `WebSocket connected to Twilio`
- `Stream started: [stream_id], Call: [call_id]`
- `Received audio chunk: 160 bytes` (repeating)
- `Queued audio chunk, queue depth: [N]` (should stay < 50)
- After hangup: `Stream stopped: [call_id]`
- `Call cleanup: [call_id], Duration: [N]s, Audio received: [N], Audio sent: [N]`

**Test 5: Connection Stability**
- Make another call
- Stay connected for 2-3 minutes
- Speak intermittently (every 15-20 seconds)
- Verify echo works consistently throughout
- Verify no disconnections or errors
- Hang up and check cleanup logs

**Test 6: Outbound Call (Optional)**
```bash
curl -X POST "http://localhost:8000/call/outbound?to_number=+1YOUR_PHONE&websocket_url=wss://YOUR_NGROK_URL/ws"
```
- Your phone should ring
- Answer and verify echo works
- Expected: Same echo behavior as inbound test

**Pass Criteria:**
- [ ] Health endpoint returns 200 OK
- [ ] TwiML endpoint returns valid XML
- [ ] Inbound call connects successfully
- [ ] You hear clear audio echo (your voice played back)
- [ ] Echo works for entire call duration (1+ minute)
- [ ] Call remains stable without disconnections
- [ ] Server logs show expected message flow
- [ ] Cleanup logs show call duration and counts
- [ ] No errors or warnings in logs
- [ ] Audio quality is clear (not garbled or distorted)

**Common Issues:**
- **No echo:** Check logs for "Received audio chunk" and "Queued audio chunk" messages. Verify audio tests pass: `pytest tests/test_audio_conversion.py`
- **Garbled audio:** Verify FFmpeg installed. Run audio tests.
- **Call doesn't connect:** Verify ngrok URL in Twilio config is HTTPS. Check server is running.
- **WebSocket disconnect:** Check ngrok didn't expire. Restart ngrok and update Twilio config.
  </how-to-verify>
  <resume-signal>
Type "approved" if all tests pass and audio echo works clearly, OR describe any issues encountered (e.g., "no echo heard" or "call disconnects after 30 seconds") for troubleshooting.
  </resume-signal>
</task>

</tasks>

<verification>
After checkpoint approval:

1. All setup documentation is accurate and complete
2. Testing checklist covers all Phase 1 requirements
3. Inbound calls work with audio echo
4. Outbound calls can be initiated
5. Call state is tracked correctly
6. Connection remains stable for 2+ minute calls
7. Audio conversion pipeline works correctly
8. No memory leaks or resource issues

Overall Phase 1 validation:
- [ ] TEL-01: System accepts inbound calls ✓
- [ ] TEL-02: System initiates outbound calls ✓
- [ ] TEL-03: Audio conversion works (mu-law ↔ PCM, 8kHz ↔ 16kHz) ✓
- [ ] TEL-04: Bidirectional audio streaming maintained ✓

Phase 1 complete: Real-time bidirectional audio streaming with Twilio working end-to-end.
</verification>

<success_criteria>
**Phase 1 Complete When:**

1. User can call Twilio number and system answers (TEL-01) ✓
2. User can speak and system receives clear audio ✓
3. System can play audio back to caller (echo test passes) ✓
4. System maintains stable connection for 2+ minute call (TEL-04) ✓
5. System can initiate outbound calls programmatically (TEL-02) ✓
6. Audio format conversion works correctly (TEL-03) ✓
7. Documentation is complete and accurate ✓
8. No blocking issues preventing Phase 2 work ✓

**Ready for Phase 2 when:**
- Telephony foundation is rock-solid and tested
- Audio pipeline handles format conversions correctly
- Bidirectional streaming is stable and performant
- User has successfully completed end-to-end call test
- No errors or warnings in production-like scenario
</success_criteria>

<output>
After checkpoint approval, create `.planning/phases/01-telephony-foundation-audio-pipeline/01-03-SUMMARY.md`
</output>
