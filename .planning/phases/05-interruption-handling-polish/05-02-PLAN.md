# Phase 05 Plan 02: Interrupt Handling

## Goal
When barge-in is detected (interrupt_event set), immediately cancel in-flight LLM + TTS generation, drain the audio queue, send a Twilio `clear` message to stop playback, and transition back to listening mode.

## Context
- Plan 05-01 provides: `interrupt_event`, `is_responding` flag, `response_tasks` dict
- AudioStreamer already has `clear_queue()` method
- Twilio supports a `clear` WebSocket message to flush server-side audio buffer
- LLM uses AsyncOpenAI streaming — cancelling the task raises `asyncio.CancelledError`
- TTS uses edge-tts streaming — same cancellation pattern

## Tasks

### Task 1: Implement interrupt handler
**Files:** `src/twilio/handlers.py`

Add `async def _handle_interrupt(stream_sid: str)`:
1. Cancel the active response task: `manager.response_tasks[stream_sid].cancel()`
2. Clear the audio queue: `streamer.clear_queue()`
3. Send Twilio `clear` message to flush server-side buffer:
   ```python
   clear_msg = {"event": "clear", "streamSid": stream_sid}
   await websocket.send_text(json.dumps(clear_msg))
   ```
4. Reset interrupt event: `manager.get_interrupt_event(stream_sid).clear()`
5. Set `manager.set_responding(stream_sid, False)`
6. Reset VAD state for the new utterance: `vad_detector.reset()`
7. Log: `"[{stream_sid}] Interrupt handled — cleared queue, cancelled generation"`

### Task 2: Wire interrupt into handle_media
**Files:** `src/twilio/handlers.py`

In `handle_media()`, after detecting barge-in (from 05-01):
- Call `await _handle_interrupt(stream_sid)` immediately
- The user's speech continues to flow into VAD/STT normally
- When the new turn completes, it spawns a new response task as usual

### Task 3: Make response task handle cancellation gracefully
**Files:** `src/twilio/handlers.py`

In `_generate_response()`:
- Wrap the LLM streaming + TTS streaming in try/except `asyncio.CancelledError`
- On cancellation: log, clean up, and return (don't re-raise — task is done)
- The `finally` block already clears `is_responding` (from 05-01)
- Track tokens generated so far (needed for Plan 05-03 context drift prevention)

### Task 4: Tests for interrupt handling
**Files:** `tests/test_interrupt_handling.py`

Tests:
1. `test_interrupt_cancels_response_task` — response task gets cancelled
2. `test_interrupt_clears_audio_queue` — queue is empty after interrupt
3. `test_interrupt_sends_twilio_clear` — clear message sent to websocket
4. `test_interrupt_resets_state` — is_responding=False, interrupt_event cleared
5. `test_new_response_after_interrupt` — can start new response after interruption
6. `test_response_handles_cancellation_gracefully` — no crash on cancel

## Dependencies
- Requires: Plan 05-01 (interrupt_event, response_tasks, is_responding)
- Provides: Full interrupt handling (cancel + clear + resume)
- Affects: Plan 05-03 will add context tracking to the cancel path

## Verification
- [ ] Interrupting AI stops audio playback immediately
- [ ] Audio queue is cleared on interrupt
- [ ] Twilio `clear` message sent on interrupt
- [ ] New user speech captured and processed after interrupt
- [ ] No crashes or hanging tasks after interruption
- [ ] All existing tests still pass
