# Phase 05 Plan 03: Context Drift Prevention + Error Recovery + Polish

## Goal
Prevent conversation history from drifting after interruptions (only commit spoken tokens, not the full unsent response) and add error recovery so the system doesn't hang up on transient failures.

## Context
- After interrupt, LLM may have generated a full response but only part was spoken
- If we save the full response to conversation history, the AI "remembers" things it never said
- This causes confusion on subsequent turns (context drift)
- Also need error recovery: LLM timeout, TTS failure, WebSocket disconnect

## Tasks

### Task 1: Track spoken vs. unsent tokens
**Files:** `src/twilio/handlers.py`

In `_generate_response()`:
- Accumulate LLM tokens into `response_tokens` list (already done)
- Track a `spoken_index` counter: how many characters of the response have been sent to TTS
- After each sentence is sent to TTS, update `spoken_index` to current position
- On cancellation: slice `response_text[:spoken_index]` = what was actually spoken
- Save only the spoken portion to conversation history, not the full response

### Task 2: Update ConversationManager for partial responses
**Files:** `src/llm/conversation.py`

Add method:
- `add_assistant_message_partial(spoken_text: str, was_interrupted: bool)` — stores the spoken portion with a note that it was cut short. Appends `" [interrupted]"` marker so the LLM knows its previous response was cut off. This helps the model understand context better.

### Task 3: Error recovery
**Files:** `src/twilio/handlers.py`

In `_generate_response()`:
- **LLM timeout/error:** Catch exception, send a filler response via TTS ("Sorry, give me a moment..."), retry once, if still fails send apology and continue listening
- **TTS failure:** Log error, skip TTS for this response, continue conversation (user can repeat)
- Keep call alive — never hang up due to transient errors

In `handle_media()`:
- **WebSocket errors:** Wrap in try/except, log, attempt recovery

### Task 4: Tests for context drift prevention and error recovery
**Files:** `tests/test_context_drift.py`

Tests:
1. `test_partial_response_saved_after_interrupt` — only spoken portion committed
2. `test_interrupted_marker_in_history` — [interrupted] marker present
3. `test_full_response_saved_when_no_interrupt` — normal case unchanged
4. `test_context_accurate_after_multiple_interrupts` — 3+ interrupts, history is clean
5. `test_llm_error_sends_filler` — LLM failure produces fallback TTS
6. `test_tts_error_continues_call` — TTS failure doesn't crash

## Dependencies
- Requires: Plan 05-01 (interrupt infrastructure), Plan 05-02 (interrupt handling)
- Provides: Context-accurate conversation after interruptions, error resilience
- Affects: Phase 6 (production deployment benefits from error recovery)

## Verification
- [ ] After interruption, conversation history only contains spoken words
- [ ] AI doesn't reference things it never said aloud
- [ ] LLM timeout triggers filler response, not silence
- [ ] TTS failure doesn't crash the call
- [ ] 3+ sequential interruptions leave clean conversation state
- [ ] All tests pass (existing + new)
