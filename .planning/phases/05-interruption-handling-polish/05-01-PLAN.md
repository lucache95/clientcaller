# Phase 05 Plan 01: Barge-in Detection

## Goal
Wire VAD speech detection into an interrupt signal when AI is mid-response, so the system knows the user is trying to interrupt.

## Context
- VAD already detects speech start via `process_chunk()` returning `is_speech: True`
- Currently, handle_media() only processes VAD/STT when audio arrives — no awareness of whether AI is speaking
- Need per-call state to track whether AI is currently generating/speaking
- Need an `asyncio.Event` per call that signals interruption

## Tasks

### Task 1: Add per-call interrupt infrastructure
**Files:** `src/twilio/handlers.py`

Add to ConnectionManager:
- `response_tasks: Dict[str, asyncio.Task]` — tracks the active LLM→TTS response task per call
- `interrupt_events: Dict[str, asyncio.Event]` — per-call interrupt signal
- `is_responding: Dict[str, bool]` — flag: is AI currently generating/speaking for this call?

Helper methods:
- `get_interrupt_event(stream_sid)` — get or create asyncio.Event for this call
- `set_responding(stream_sid, bool)` — mark whether AI is actively responding
- Cleanup in `handle_stop()` for all new dicts

### Task 2: Detect barge-in in handle_media
**Files:** `src/twilio/handlers.py`

In `handle_media()`, after VAD runs:
- If `vad_result["is_speech"]` AND `manager.is_responding.get(stream_sid, False)`:
  - This is a barge-in — set `manager.get_interrupt_event(stream_sid).set()`
  - Log: `"[{stream_sid}] Barge-in detected — user interrupting AI"`
- Continue feeding audio to STT regardless (user's new utterance needs to be captured)

### Task 3: Refactor response pipeline into cancellable task
**Files:** `src/twilio/handlers.py`

Extract the LLM→TTS pipeline (lines 202-233) into an async function `_generate_response(stream_sid, user_text)`:
- Sets `manager.set_responding(stream_sid, True)` at start
- Clears it at end (in finally block)
- Creates the function as a separate async task so it can be cancelled
- Store task in `manager.response_tasks[stream_sid]`

### Task 4: Tests for barge-in detection
**Files:** `tests/test_barge_in.py`

Tests:
1. `test_interrupt_event_created_per_call` — event exists after call setup
2. `test_barge_in_sets_interrupt_event` — speech during responding sets event
3. `test_no_barge_in_when_not_responding` — speech during listening doesn't set event
4. `test_interrupt_event_cleanup` — event removed on call stop

## Dependencies
- Requires: Phase 4 complete (TTS pipeline working)
- Provides: `interrupt_event` signal, `is_responding` flag, cancellable response task
- Affects: Plan 05-02 will use interrupt_event to cancel in-flight work

## Verification
- [ ] VAD speech during AI response sets interrupt_event
- [ ] VAD speech during listening does NOT set interrupt_event
- [ ] Response pipeline runs as cancellable asyncio.Task
- [ ] All new state cleaned up on call disconnect
- [ ] All existing tests still pass
