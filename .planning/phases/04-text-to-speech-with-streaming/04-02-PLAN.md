---
phase: 04-text-to-speech-with-streaming
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - src/tts/stream.py
  - tests/test_tts_stream.py
autonomous: true
requirements: [TTS-01, TTS-02]

must_haves:
  truths:
    - "TTS audio pipeline converts TTS output to Twilio mu-law format"
    - "Pipeline resamples from TTS native rate to 8kHz for Twilio"
    - "Pipeline produces base64-encoded mu-law chunks ready for AudioStreamer"
    - "Streaming: yields chunks as they're ready, doesn't wait for full synthesis"
  artifacts:
    - path: "src/tts/stream.py"
      provides: "TTS-to-Twilio audio streaming pipeline"
      exports: ["TTSStream"]
      min_lines: 50
    - path: "tests/test_tts_stream.py"
      provides: "Unit tests for TTS stream pipeline"
      min_lines: 30
  key_links:
    - from: "src/tts/stream.py"
      to: "src/tts/client.py"
      via: "TTSClient.synthesize() output"
      pattern: "TTSClient"
    - from: "src/tts/stream.py"
      to: "src/audio/resampling.py"
      via: "resample to 8kHz"
      pattern: "resample"
    - from: "src/tts/stream.py"
      to: "src/audio/conversion.py"
      via: "PCM to mu-law conversion"
      pattern: "pcm_to_mulaw"
---

<objective>
Create a streaming pipeline that converts TTS audio output into Twilio-ready format.

Purpose: Bridge TTSClient output (24kHz PCM) to Twilio's required format (8kHz mu-law base64). Stream chunks as they're generated for minimum latency.

Output: TTSStream class that takes text, runs TTS, resamples, converts to mu-law, and yields base64 payloads ready for AudioStreamer.queue_audio().
</objective>

<context>
@.planning/PROJECT.md
@src/audio/conversion.py
@src/audio/resampling.py
@src/audio/buffers.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TTSStream pipeline</name>
  <files>src/tts/stream.py</files>
  <action>
Create `src/tts/stream.py`:

The TTSStream wraps the full pipeline:
1. Text → TTSClient.synthesize() → PCM chunks at 24kHz
2. Resample 24kHz → 8kHz (using librosa kaiser_fast)
3. Convert PCM → mu-law bytes
4. Base64 encode for Twilio
5. Yield as ready-to-send payloads

Key design:
- `generate(text: str)` — async generator yielding base64 mu-law payloads
- `generate_streaming(text_stream: AsyncGenerator)` — accepts streaming LLM tokens
- Uses existing audio conversion utilities (resample_16k_to_8k pattern but from 24kHz)
- Adds resample_to_8k helper for arbitrary input sample rates
- Each yielded payload is one Twilio media message worth of audio
  </action>
  <verify>
```bash
python -c "from src.tts.stream import TTSStream; print('TTSStream imported')"
```
  </verify>
  <done>
TTSStream pipeline bridges TTS output to Twilio format with streaming.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create unit tests for TTSStream</name>
  <files>tests/test_tts_stream.py</files>
  <action>
Create `tests/test_tts_stream.py`:

Tests:
- TTSStream.generate() yields base64 strings
- Output is valid base64 (decodable)
- Pipeline uses correct sample rate conversion
- Handles empty text gracefully

Uses mocking to avoid loading actual TTS model.
  </action>
  <verify>
```bash
pytest tests/test_tts_stream.py -v
```
  </verify>
  <done>
Unit tests verify TTSStream pipeline contract.
  </done>
</task>

</tasks>

<verification>
1. **Module imports:** `python -c "from src.tts.stream import TTSStream"`
2. **Tests pass:** `pytest tests/test_tts_stream.py -v`
</verification>

<success_criteria>
- TTSStream converts TTS output → Twilio mu-law base64
- Streaming: yields payloads as TTS generates chunks
- Resampling and format conversion are correct
- Unit tests pass
- Ready for handler integration in Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/04-text-to-speech-with-streaming/04-02-SUMMARY.md` following the summary template.
</output>
